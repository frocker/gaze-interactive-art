<!DOCTYPE html>
<html>
<head>
  <style>
    body{
      background:black;
      font-family: Helvetica;
    }
    #header{
      width:100%;
      color:white;
      text-align: center;
      font-size:30pt;
      margin: 10px 0 0 0;
    }
    .paintingSelected {
      box-shadow: inset 0px -10px 0px 0px rgba(0,196,255,1);
    }

    .gazeIndicator{
          position:relative;
    }
    .gazeIndicator:after{
      position:absolute;
      bottom:0;
      left:0%;
      width:0;
      height:10px;
      background:rgba(0,196,255,1);
      display:block;
      content:'';
      transition: width 2s ease-in-out;
    }

    .gazeIndicatorGazing:after{
      width:100%;
    }

    #columnsContainer{
      display: flex;
      flex: 1;
    }

    #gridContainer{
      flex: 1;
      order: 2;
      display:grid;
      grid-template-rows: 39% 39% 19%;
      grid-template-columns: 49% 49%;
      grid-column-gap: 10px;
      grid-row-gap: 10px;
    }
    #confirmButton{
      line-height: 100px;
      font-size: 24pt;
      text-align:center;
      background:#272727;
      color:white;
      grid-column: span 2;
      height:100%;
    }
    .item{
      position:relative;
      background-size:cover;
      overflow:hidden;
    }
    .item_content{
      width:100%;
      color:white;
      background-color:rgba(0, 0, 0, 0.5);
      padding:20px;
      bottom:10px;
      position:absolute;
    }
    .item_title{
      font-size:28pt;
    }
    .item_author{
      font-size:20pt;
    }
    .scrollButton{
      width: 10%;
    }
    #container{
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }
    
  </style>
</head>
<body>

  <div id="container">
    <div id="header">
      SELECT A PAINTING
    </div>
    <div id="columnsContainer">
      <div class="scrollButton" style="order:l;">
      </div>

        <div id="gridContainer">

          <div class="gazeIndicator item"  gazeOverClass='gazeIndicatorGazing' gazeAware>
            <div class="item_content" >
              <div class="item_title">
              </div>
              <div class = "item_author">
              </div>
            </div>
          </div>

          <div class="gazeIndicator item"  gazeOverClass='gazeIndicatorGazing' gazeAware>
            <div class="item_content" >
              <div class="item_title">
              </div>
              <div class = "item_author">
              </div>
            </div>
          </div>

          <div id="test_3" class="item gazeIndicator"  gazeOverClass='gazeIndicatorGazing' gazeAware>
            <div class="item_content" >
              <div class="item_title">
              </div>
              <div class = "item_author">
              </div>
            </div>
          </div>
          <div id="test_4" class="item gazeIndicator"  gazeOverClass='gazeIndicatorGazing' gazeAware>
            <div class="item_content" >
              <div class="item_title">
              </div>
              <div class = "item_author">
              </div>
            </div>
          </div>
          <div id = "confirmButton" class=" gazeIndicator" gazeAction = "openPainting()" gazeOverClass='gazeIndicatorGazing' gazeAware>
            
          </div>
        </div>


      <div class="scrollButton" style="order:3;">
      </div>

    </div>
  </div>

  <script>

  var painting = undefined;
  var paintings =[];

  loadPaintings();
  setMenu(0);


  //Get Gaze coordinates
   var ipc = require('electron').ipcRenderer;
    ipc.on('gaze-pos', (event, arg) => {
      if(arg.timestamp )
      gazePosition.x = arg.x;
      gazePosition.y = arg.y;
    });
    var gazePosition = {x : 0, y: 0};
    var gazeAwareElements = [];

    function setupGaze(){
      var arr_elms = [];
      arr_elms = document.body.getElementsByTagName("*");
      var elms_len = arr_elms.length;

      for (var i = 0; i < elms_len; i++) {
        if(arr_elms[i].getAttribute("gazeAware") != null){

         gazeAwareElements.push({'element': arr_elms[i], 'dwell':false, 'dwellTimeout': null});
         console.log( arr_elms[i].getBoundingClientRect());
         console.log({'element': arr_elms[i], 'dwell':false, 'dwellTimeout': null});
        }
      }
    }

    setupGaze();
    setInterval(updateGaze, 10);



    function testGazeAction(){
      console.log("test Gaze Action");
    }

    function openPainting(){
      console.log("open painting");
      if (painting != undefined){
        ipc.send('open', painting);
      }
    }

    function setPainting(thisPainting){
      painting = thisPainting;
      console.log('setting: '+thisPainting);
      document.getElementById("confirmButton").innerHTML = "View "+thisPainting;
      var items = document.getElementsByClassName('item');
      for (var i = 0; i < items.length; i++) {
        items[i].classList.remove("paintingSelected");
      }
      var thisItem = document.getElementById(painting);
      thisItem.className += " paintingSelected";
    }

 

    function updateGaze() {
      for (var i = 0; i < gazeAwareElements.length; i++) {
        var el = gazeAwareElements[i].element;
        var elRect = el.getBoundingClientRect();
        var hoverClass = el.getAttribute("gazeOverClass");
        var actionFunction = el.getAttribute("gazeAction");

        if(gazePosition.x > elRect.left
          && gazePosition.x < elRect.left + elRect.width
          && gazePosition.y > elRect.top
          && gazePosition.y < elRect.top + elRect.height){
            //Gazing
            if(gazeAwareElements[i].dwell){
              //No change
            } else{
              gazeAwareElements[i].dwell=true;
              el.className += " " + hoverClass;
              gazeAwareElements[i].dwellTimeout = setTimeout(actionFunction , 2000);
              //gazeAwareElements[i].dwellTimeout = setTimeout(function(){window[actionFunction]()}, 2000);
            }
          } else {
            //Not Gazing
            if(gazeAwareElements[i].dwell){
              gazeAwareElements[i].dwell=false;
              el.classList.remove(hoverClass);
               clearTimeout(gazeAwareElements[i].dwellTimeout);
            }
          }
      }
    }

    
    function setMenu(index){
      //for items 0->4
      var items = document.getElementsByClassName('item');
      for (var i = 0; i < items.length; i++) {
        if(paintings[i+index]!=undefined){
            items[i].id = paintings[i+index].id;
            items[i].style.backgroundImage = 'url('+paintings[i+index].image+')';
            items[i].setAttribute("gazeAction", "setPainting('" + paintings[i+index].id + "')" );

            var title = items[i].getElementsByClassName("item_title")[0];
            var artist = items[i].getElementsByClassName("item_author")[0];
            title.innerHTML = paintings[i+index].title + " (" + paintings[i+index].year + ")";
            artist.innerHTML = paintings[i+index].artist;

        }
      }

      
    }

    function loadPaintings(){
      var normalizedPath = require("path").join(__dirname, "paintings");

      require("fs").readdirSync(normalizedPath).forEach(function(file) {
        paintingObject = require("./paintings/" + file);
        var fileName = file.replace('.json','');
        //console.log(fileName);
        //console.log(paintingObject);
        paintingObject.id=fileName;
        paintings.push(paintingObject);
      });

    }
  </script>
</body>
