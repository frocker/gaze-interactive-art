<!DOCTYPE html>
<html>
<body style="margin:0;overflow:hidden;">

<canvas id="canvas" style='background-image:url(bosch.jpg)'>
</canvas>

<script>
var canvas = document.getElementById("canvas"),
    ctx = canvas.getContext("2d");

canvas.width = 1920;
canvas.height = 1080;

var mousePos = {x : 0, y: 0};

var gazePoints = [
        {x: 800, y: 200, r :60},
        {x: 1600, y: 80, r: 60},
        {x: 300, y: 90, r: 60},
        {x: 400, y: 800, r: 60},
        {x: 1600, y: 600, r: 300}
    ];

function getMousePos(canvas, evt) {
  var rect = canvas.getBoundingClientRect();
  return {
    x: evt.clientX - rect.left,
    y: evt.clientY - rect.top
  };
}

canvas.addEventListener('mousemove', function(evt) {
  mousePos = getMousePos(canvas, evt);
  /*var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
  console.log(message);*/
  }, false);


var imageDefault = new Image();
imageDefault.src = "bosch.jpg";
var imageDataDefault;
var pixelsDefault;
var numPixels;

var imageModulated = new Image();
var imageDataModulated;
var pixelsModulated;

imageDefault.onload = function(){

    //Do Initial image setup and modulations
    console.log("ImgDefault Load");
    ctx.drawImage(imageDefault,0,0);
    imageDataDefault = ctx.getImageData(0, 0, canvas.width, canvas.height);
    imageDataModulated = ctx.getImageData(0, 0, canvas.width, canvas.height);
    pixelsDefault = imageDataDefault.data;
    numPixels = imageDataDefault.width * imageDataDefault.height;
    pixelsModulated  = imageDataModulated.data;

    for (var i = 0; i < numPixels; i++) {
      pixelsModulated[i*4] = pixelsDefault[i*4] * 1.05; // Red
      pixelsModulated[i*4+1] = pixelsDefault[i*4+1] * 1.05; // Green
      pixelsModulated[i*4+2] = pixelsDefault[i*4+2] * 1.05; // Blue
    }
    ctx.putImageData(imageDataModulated, 0, 0);
    imageModulated.src = canvas.toDataURL();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    render();
}


var on = true;

var fps = 5;
var now;
var then = Date.now();
var interval = 1000/fps;
var delta;

function render() {
  now = Date.now();
  delta = now - then;

  if (delta > interval) {
    on = !on;
    then = now - (delta % interval);
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (on){
    var temp = document.createElement('canvas'),
        tx = temp.getContext('2d');
    temp.width = ctx.canvas.width;
    temp.height = ctx.canvas.height;
    for (var i = 0; i < gazePoints.length; i++) {
      tx.drawImage(imageModulated, 0, 0);
      if(clipArc(tx, gazePoints[i].x,gazePoints[i].y,gazePoints[i].r)){
        ctx.drawImage(temp, 0, 0);
      }
    }
    on = true;
    //Garbage Collection, good job javascript
    temp.height = null;
    temp.width = null;
  }
  requestAnimationFrame(render);
}

//Returns true, false, for if point should be rendered.
function clipArc(context, x, y, r) {
    context.globalCompositeOperation = 'destination-in';
    context.filter = "blur(25px)";  // "feather"
    context.beginPath();

    context.arc(x, y, r, 0, 2 * Math.PI);
    //Check if mouse is in Path
    if (context.isPointInPath(mousePos.x, mousePos.y)) {
      var renderPoint = false;
    } else {
      var renderPoint = true;
    }

    context.fill();

    // reset comp. mode and filter
    context.globalCompositeOperation = 'source-over';
    context.filter = "none";
    return renderPoint;
}


</script>

</body>
</html>
