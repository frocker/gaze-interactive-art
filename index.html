<!DOCTYPE html>
<html>
<head>
  <style>
  body{
    font-family:Helvetica;
    margin:0;
    background:black;
  }
    #infoText{
      width:100%;
      box-sizing: border-box;
      padding:20px;
      position:absolute;
      font-size:16pt;
      color:white;
      background-color:rgba(0, 0, 0, 0.5);
      text-align:center;
      visibility:hidden;
    }
  </style>

</head>

<body>
<div id="infoText"></div>
<canvas id="canvas" style="background-size:contain;margin-left:auto;margin-right:auto;display:block;">
</canvas>



<script>
//Get Gaze coordinates
var ipc = require('electron').ipcRenderer;
ipc.on('gaze-pos', (event, arg) => {
  if(arg.timestamp )
  gazePosition.x = arg.x;
  gazePosition.y = arg.y;
});
var gazePosition = {x : 0, y: 0};

/*Load Image here*/
let params = (new URL(location)).searchParams;
var paintingId = params.get("painting");
console.log(paintingId);

var paintingInfo = require('./paintings/'+paintingId+'.json');

setupGazepoints();

var canvas = document.getElementById("canvas"),
    ctx = canvas.getContext("2d");

canvas.style.backgroundImage = 'url('+paintingInfo.image+')';

var viewport = {width:undefined, height:undefined, aspectratio: undefined};
viewport.width = window.innerWidth;
viewport.height = window.innerHeight;
viewport.aspectratio = viewport.width/viewport.height;

/*var imageDimensions = {width:4096, height:2884, aspectratio: undefined};*/

paintingInfo.aspectratio = paintingInfo.width/paintingInfo.height;
/*var gazePoints = [
        {x: 1200, y: 700, r :260, dwelltime: 0, text: "Primo de Rivera, who assumed Spain’s dictatorship in 1923, instituted strict measures to repress Catalan separatism. By depicting the Catalan and French flags together, across the border post from the Spanish flag, Miró announced his allegiance to the Catalan cause.", enabled: true},
        {x: 3660, y: 1360, r: 360, dwelltime: 0, text: "The stylized figure with a plow has its source in the prehistoric cave paintings of Altamira, which Miró knew well.", enabled: true},
        {x: 2800, y: 1100, r: 300, dwelltime: 0, text: "Miró found something alive and magical in all things: the gigantic ear affixed to the trunk of the tree reflects his belief that every object contains a living soul.", enabled: true}
    ];
*/

var imageDefault = new Image();
imageDefault.src = paintingInfo.image;
var renderedScaleFactor;
//console.log(viewport);
//console.log(imageDimensions);
if(viewport.aspectratio<paintingInfo.aspectratio){
  //Fit width
  canvas.width = viewport.width;
  canvas.height = paintingInfo.height * (canvas.width/paintingInfo.width);
  renderedScaleFactor = canvas.width/paintingInfo.width;
} else {
  //Fit Height
  canvas.height = viewport.height;
  canvas.width = paintingInfo.width * (canvas.height/paintingInfo.height);
  renderedScaleFactor = canvas.height/paintingInfo.height;
}
var canvasMargin = canvas.getBoundingClientRect().left;
var imageDataDefault;
var pixelsDefault;
var numPixels;

var imageModulated = new Image();
var imageDataModulated;
var pixelsModulated;

imageDefault.onload = function(){
    //Do Initial image setup and modulations
    console.log("ImgDefault Load");
    ctx.drawImage(imageDefault,0,0, canvas.width, canvas.height);
    imageDataDefault = ctx.getImageData(0, 0, canvas.width, canvas.height);
    imageDataModulated = ctx.getImageData(0, 0, canvas.width, canvas.height);
    pixelsDefault = imageDataDefault.data;
    numPixels = imageDataDefault.width * imageDataDefault.height;
    pixelsModulated  = imageDataModulated.data;

    for (var i = 0; i < numPixels; i++) {
      pixelsModulated[i*4] = pixelsDefault[i*4] * 1.2; // Red
      pixelsModulated[i*4+1] = pixelsDefault[i*4+1] * 1.2; // Green
      pixelsModulated[i*4+2] = pixelsDefault[i*4+2] * 1.2; // Blue
    }
    ctx.putImageData(imageDataModulated, 0, 0);
    imageModulated.src = canvas.toDataURL();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    render();
}

var renderPoints = true;
var on = true;

var fps = 5;
var now;
var then = Date.now();
var interval = 1000/fps;
var delta;

var DWELL_TIME = 2000;

function render() {
  now = Date.now();
  delta = now - then;

  if (delta > interval) {
    on = !on;
    then = now - (delta % interval);
  }

ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (renderPoints){
    if (on){
      //ToDo: Refractor this so we don't need temp canvas
      var temp = document.createElement('canvas'),
          tx = temp.getContext('2d');
      temp.width = ctx.canvas.width;
      temp.height = ctx.canvas.height;
      for (var i = 0; i < paintingInfo.gazePoints.length; i++) {
      if(paintingInfo.gazePoints[i].enabled){
          tx.drawImage(imageModulated, 0, 0);
          if(clipArc(tx, paintingInfo.gazePoints[i].x*renderedScaleFactor,paintingInfo.gazePoints[i].y*renderedScaleFactor,paintingInfo.gazePoints[i].r*renderedScaleFactor)){
            paintingInfo.gazePoints[i].dwelltime = 0;
            ctx.drawImage(temp, 0, 0);
          } else {
            paintingInfo.gazePoints[i].dwelltime += delta;
            if(paintingInfo.gazePoints[i].dwelltime>DWELL_TIME){
              paintingInfo.gazePoints[i].enabled=false;
              //set visibility to true
              document.getElementById("infoText").innerHTML=paintingInfo.gazePoints[i].text;
              document.getElementById("infoText").style.visibility="visible";
              renderPoints = false;
              setTimeout(function() { hideInfoText(); }, 8000);
            }
          }
        }
      }
      //Garbage Collection, gg javascript
      temp.height = null;
      temp.width = null;
    }
  }
requestAnimationFrame(render);
    
}

function hideInfoText(){
  document.getElementById("infoText").style.visibility="hidden";
  renderPoints = true;

}

//Returns true, false, for if point should be rendered.
function clipArc(context, x, y, r) {
    context.globalCompositeOperation = 'destination-in';
    context.filter = "blur(10px)";  // "feather"
    context.beginPath();

    context.arc(x, y, r, 0, 2 * Math.PI);
    //Check if mouse is in Path
    if (context.isPointInPath(gazePosition.x-canvasMargin, gazePosition.y)) {
      var renderPoint = false;
    } else {
      var renderPoint = true;
    }

    context.fill();

    // reset comp. mode and filter
    context.globalCompositeOperation = 'source-over';
    context.filter = "none";
    return renderPoint;
}

function setupGazepoints(){
  for (var i = 0; i < paintingInfo.gazePoints.length; i++) {
    paintingInfo.gazePoints[i].enabled = true;
    paintingInfo.gazePoints[i].dwelltime = 0;
  }
}

</script>

</body>
</html>
